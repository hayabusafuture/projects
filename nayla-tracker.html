<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nayla's Vaccine & Growth Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8fafc; }
        .timeline-line { position: absolute; left: 19px; top: 0; bottom: 0; width: 2px; background-color: #c7d2fe; }
        .timeline-dot { position: absolute; left: 10px; top: 0; width: 20px; height: 20px; border-radius: 50%; background-color: #6366f1; border: 4px solid #f8fafc; }
        .vaccine-card { transition: all 0.2s; }
        .vaccine-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border-color: #c7d2fe; }
        
        /* Modal Styles */
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        dialog[open] {
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="text-slate-800 pb-12">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-3xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-sm">
                    <i class="fa-solid fa-baby text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-900 leading-tight" id="nav-title">Nayla's Vaccine Plan</h1>
                    <p class="text-xs text-slate-500 font-medium" id="nav-subtitle">Born: 2025-11-11</p>
                </div>
            </div>
            <button onclick="toggleLang()" class="flex items-center gap-1.5 px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-medium rounded-full transition-colors">
                <i class="fa-solid fa-globe"></i>
                <span id="lang-btn-text">ä¸­æ–‡</span>
            </button>
        </div>
    </nav>

    <main class="max-w-3xl mx-auto px-4 py-6">

        <!-- Growth Tracker Section -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 mb-6">
            <div class="flex items-center gap-2 mb-4">
                <div class="bg-emerald-100 text-emerald-600 p-1.5 rounded-lg w-8 h-8 flex items-center justify-center">
                    <i class="fa-solid fa-chart-line"></i>
                </div>
                <h2 class="font-bold text-slate-800" id="growth-title">Growth Tracker (WHO Standards)</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Inputs -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="flex items-center gap-1.5 text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5">
                            <i class="fa-solid fa-weight-scale"></i> <span id="label-weight">Weight (kg)</span>
                        </label>
                        <input type="number" id="input-weight" placeholder="e.g. 4.5" oninput="updateGrowth()" 
                            class="w-full bg-slate-50 border border-slate-300 text-slate-900 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2.5">
                    </div>
                    <div>
                        <label class="flex items-center gap-1.5 text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5">
                            <i class="fa-solid fa-ruler-vertical"></i> <span id="label-height">Height (cm)</span>
                        </label>
                        <input type="number" id="input-height" placeholder="e.g. 54" oninput="updateGrowth()" 
                            class="w-full bg-slate-50 border border-slate-300 text-slate-900 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2.5">
                    </div>
                </div>

                <!-- Results -->
                <div class="bg-slate-50 rounded-xl p-4 border border-slate-100 flex flex-col justify-center">
                    <p class="text-xs text-slate-500 mb-3 text-center" id="growth-info">
                        Normal range is 3rd - 97th percentile
                    </p>
                    <div class="flex justify-around gap-2">
                        <!-- Weight Result -->
                        <div class="text-center w-1/2">
                            <span class="text-xs font-semibold text-slate-400 uppercase block mb-1" id="res-label-weight">Weight</span>
                            <div id="weight-badge"><span class="text-slate-300 text-sm">-</span></div>
                            <div class="text-[10px] text-slate-400 mt-1" id="weight-range"></div>
                        </div>
                        
                        <div class="w-px bg-slate-200"></div>

                        <!-- Height Result -->
                        <div class="text-center w-1/2">
                            <span class="text-xs font-semibold text-slate-400 uppercase block mb-1" id="res-label-height">Height</span>
                            <div id="height-badge"><span class="text-slate-300 text-sm">-</span></div>
                            <div class="text-[10px] text-slate-400 mt-1" id="height-range"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                
                <!-- Country -->
                <div class="space-y-1.5">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider" id="label-region">Region</label>
                    <div class="relative">
                        <select id="filter-country" onchange="renderApp()" class="w-full appearance-none bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5">
                            <option value="all" id="opt-all">Compare (TW & SG)</option>
                            <option value="TW" id="opt-tw">Taiwan (TW)</option>
                            <option value="SG" id="opt-sg">Singapore (SG)</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- Type -->
                <div class="space-y-1.5">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider" id="label-type">Vaccine Type</label>
                    <div class="relative">
                        <select id="filter-type" onchange="renderApp()" class="w-full appearance-none bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5">
                            <option value="all" id="opt-type-all">All Types</option>
                            <!-- Options filled by JS -->
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- Optional Toggle -->
                <div class="space-y-1.5 flex flex-col justify-end">
                    <label class="flex items-center p-2.5 bg-slate-50 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                        <input type="checkbox" id="filter-optional" onchange="renderApp()" class="w-4 h-4 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500">
                        <span class="ml-2 text-sm font-medium text-slate-700" id="label-optional">Show Optional / Self-paid</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Timeline Container -->
        <div id="timeline-container" class="space-y-8">
            <!-- Injected via JS -->
        </div>

    </main>

    <!-- Wikipedia Modal -->
    <dialog id="wiki-dialog" class="w-full max-w-lg rounded-2xl shadow-2xl p-0 backdrop:bg-gray-900/50">
        <div class="bg-white flex flex-col max-h-[85vh]">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-slate-100 bg-slate-50">
                <h3 id="wiki-title" class="font-bold text-lg text-slate-800">Loading...</h3>
                <button onclick="closeWiki()" class="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-200 transition-colors">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <!-- Content -->
            <div id="wiki-content" class="p-5 overflow-y-auto">
                <div class="flex justify-center py-8">
                    <i class="fa-solid fa-circle-notch fa-spin text-indigo-500 text-2xl"></i>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-slate-100 flex justify-end">
                <a id="wiki-external-link" href="#" target="_blank" class="text-sm font-medium text-indigo-600 hover:text-indigo-800 hover:underline">
                    Read full article on Wikipedia <i class="fa-solid fa-arrow-up-right-from-square ml-1"></i>
                </a>
            </div>
        </div>
    </dialog>

    <script>
        // --- Configuration ---
        const BIRTH_DATE = '2025-11-11';
        let state = {
            lang: 'en',
            currentAgeMonths: 0
        };

        // --- Data: WHO Girls Standards (0-24m) 3rd-97th percentile ---
        const whoGirlsStandards = {
            0: { w: [2.4, 4.2], h: [46.1, 53.7] },
            1: { w: [3.2, 5.4], h: [50.0, 57.4] },
            2: { w: [3.9, 6.6], h: [53.2, 60.9] },
            3: { w: [4.5, 7.5], h: [55.8, 63.8] },
            4: { w: [5.0, 8.2], h: [57.8, 66.4] },
            5: { w: [5.4, 8.8], h: [59.6, 68.5] },
            6: { w: [5.7, 9.3], h: [61.2, 70.3] },
            7: { w: [6.0, 9.8], h: [62.7, 71.9] },
            8: { w: [6.3, 10.2], h: [64.0, 73.5] },
            9: { w: [6.5, 10.5], h: [65.3, 75.0] },
            10: { w: [6.7, 10.9], h: [66.5, 76.4] },
            11: { w: [6.9, 11.2], h: [67.7, 77.8] },
            12: { w: [7.0, 11.5], h: [68.9, 79.2] },
            15: { w: [7.6, 12.4], h: [72.0, 83.0] },
            18: { w: [8.1, 13.2], h: [74.9, 86.5] },
            24: { w: [9.0, 14.8], h: [80.0, 92.9] },
        };

        // --- Data: Vaccines (Verified) ---
        // Wiki keys used for API fetch
        const rawVaccines = [
            // Month 0
            { 
                id: 'bcg-sg', month: 0, type: 'Respiratory', 
                name: { en: "BCG", zh: "å¡ä»‹è‹—" }, 
                desc: { en: "Tuberculosis protection (SG Schedule).", zh: "é é˜²çµæ ¸ç—… (æ–°åŠ å¡æ™‚ç¨‹)ã€‚" }, 
                status: { TW: 'N', SG: 'M' },
                wiki: { en: "BCG_vaccine", zh: "å¡ä»‹è‹—" }
            },
            { 
                id: 'hepb-1', month: 0, type: 'Hepatic', 
                name: { en: "Hepatitis B (Dose 1)", zh: "Bå‹è‚ç‚ (ç¬¬1åŠ‘)" }, 
                desc: { en: "Within 24hr of birth.", zh: "å‡ºç”Ÿ24å°æ™‚å…§æ¥ç¨®ã€‚" }, 
                status: { TW: 'M', SG: 'M' },
                wiki: { en: "Hepatitis_B_vaccine", zh: "Bå‹è‚ç‚ç–«è‹—" }
            },
            // Month 1
            { 
                id: 'hepb-2-tw', month: 1, type: 'Hepatic', 
                name: { en: "Hepatitis B (Dose 2)", zh: "Bå‹è‚ç‚ (ç¬¬2åŠ‘)" }, 
                desc: { en: "Standard TW schedule.", zh: "å°ç£å¸¸è¦æ™‚ç¨‹ã€‚" }, 
                status: { TW: 'M', SG: 'N' },
                wiki: { en: "Hepatitis_B_vaccine", zh: "Bå‹è‚ç‚ç–«è‹—" }
            },
            // Month 2
            { 
                id: '6in1-1', month: 2, type: 'Combination', 
                name: { en: "6-in-1 (DTaP-IPV-Hib-HepB) (D1)", zh: "å…­åˆä¸€ç–«è‹— (ç¬¬1åŠ‘)" }, 
                desc: { en: "Diphtheria, Tetanus, Pertussis, Polio, Hib, HepB.", zh: "ç™½å–‰ã€ç ´å‚·é¢¨ã€ç™¾æ—¥å’³ã€å°å…’éº»ç—ºã€Bå‹å—œè¡€æ¡¿èŒã€Bè‚ã€‚" }, 
                status: { TW: 'N', SG: 'M' },
                wiki: { en: "Hexavalent_vaccine", zh: "å…­åˆä¸€ç–«è‹—" }
            },
            { 
                id: '5in1-1', month: 2, type: 'Combination', 
                name: { en: "5-in-1 (DTaP-IPV-Hib) (D1)", zh: "äº”åˆä¸€ç–«è‹— (ç¬¬1åŠ‘)" }, 
                desc: { en: "Standard TW schedule (No HepB).", zh: "å°ç£å¸¸è¦ (ä¸å«Bè‚)ã€‚" }, 
                status: { TW: 'M', SG: 'N' },
                wiki: { en: "Pentavalent_vaccine", zh: "äº”åˆä¸€ç–«è‹—" }
            },
            { 
                id: 'pcv-1', month: 2, type: 'Respiratory', 
                name: { en: "Pneumococcal (PCV13/15) (D1)", zh: "13/15åƒ¹çµåˆå‹è‚ºç‚éˆçƒèŒ (ç¬¬1åŠ‘)" }, 
                desc: { en: "Pneumonia/Meningitis.", zh: "é é˜²è‚ºç‚åŠè…¦è†œç‚ã€‚" }, 
                status: { TW: 'M', SG: 'M' },
                wiki: { en: "Pneumococcal_conjugate_vaccine", zh: "è‚ºç‚éˆçƒèŒç–«è‹—" }
            },
            { 
                id: 'rota-1', month: 2, type: 'Gastrointestinal', 
                name: { en: "Rotavirus (Dose 1)", zh: "è¼ªç‹€ç—…æ¯’ (ç¬¬1åŠ‘)" }, 
                desc: { en: "Oral vaccine.", zh: "å£æœç–«è‹—ã€‚" }, 
                status: { TW: 'O', SG: 'O' },
                wiki: { en: "Rotavirus_vaccine", zh: "è¼ªç‹€ç—…æ¯’ç–«è‹—" }
            },
            // Month 4
            { 
                id: '6in1-2', month: 4, type: 'Combination', 
                name: { en: "6-in-1 (D2)", zh: "å…­åˆä¸€ç–«è‹— (ç¬¬2åŠ‘)" }, 
                desc: { en: "SG Schedule.", zh: "æ–°åŠ å¡æ™‚ç¨‹ã€‚" }, 
                status: { TW: 'N', SG: 'M' },
                wiki: { en: "Hexavalent_vaccine", zh: "å…­åˆä¸€ç–«è‹—" }
            },
            { 
                id: '5in1-2', month: 4, type: 'Combination', 
                name: { en: "5-in-1 (D2)", zh: "äº”åˆä¸€ç–«è‹— (ç¬¬2åŠ‘)" }, 
                desc: { en: "TW Schedule.", zh: "å°ç£æ™‚ç¨‹ã€‚" }, 
                status: { TW: 'M', SG: 'N' },
                wiki: { en: "Pentavalent_vaccine", zh: "äº”åˆä¸€ç–«è‹—" }
            },
            { 
                id: 'pcv-2', month: 4, type: 'Respiratory', 
                name: { en: "Pneumococcal (PCV13/15) (D2)", zh: "è‚ºç‚éˆçƒèŒ (ç¬¬2åŠ‘)" }, 
                desc: { en: "Second dose.", zh: "ç¬¬äºŒåŠ‘ã€‚" }, 
                status: { TW: 'M', SG: 'M' },
                wiki: { en: "Pneumococcal_conjugate_vaccine", zh: "è‚ºç‚éˆçƒèŒç–«è‹—" }
            },
            // Month 5
            { 
                id: 'bcg-tw', month: 5, type: 'Respiratory', 
                name: { en: "BCG", zh: "å¡ä»‹è‹—" }, 
                desc: { en: "Tuberculosis protection (TW: 5-8 months).", zh: "é é˜²çµæ ¸ç—… (å°ç£å»ºè­°5-8å€‹æœˆæ¥ç¨®)ã€‚" }, 
                status: { TW: 'M', SG: 'N' },
                wiki: { en: "BCG_vaccine", zh: "å¡ä»‹è‹—" }
            },
            // Month 6
            { 
                id: '6in1-3', month: 6, type: 'Combination', 
                name: { en: "6-in-1 (D3)", zh: "å…­åˆä¸€ç–«è‹— (ç¬¬3åŠ‘)" }, 
                desc: { en: "SG Schedule.", zh: "æ–°åŠ å¡æ™‚ç¨‹ã€‚" }, 
                status: { TW: 'N', SG: 'M' },
                wiki: { en: "Hexavalent_vaccine", zh: "å…­åˆä¸€ç–«è‹—" }
            },
            { 
                id: '5in1-3', month: 6, type: 'Combination', 
                name: { en: "5-in-1 (D3)", zh: "äº”åˆä¸€ç–«è‹— (ç¬¬3åŠ‘)" }, 
                desc: { en: "TW Schedule.", zh: "å°ç£æ™‚ç¨‹ã€‚" }, 
                status: { TW: 'M', SG: 'N' },
                wiki: { en: "Pentavalent_vaccine", zh: "äº”åˆä¸€ç–«è‹—" }
            },
            { 
                id: 'hepb-3-tw', month: 6, type: 'Hepatic', 
                name: { en: "Hepatitis B (Dose 3)", zh: "Bå‹è‚ç‚ (ç¬¬3åŠ‘)" }, 
                desc: { en: "TW Schedule final primary dose.", zh: "å°ç£æ™‚ç¨‹åŸºç¤åŠ‘æœ€å¾Œä¸€åŠ‘ã€‚" }, 
                status: { TW: 'M', SG: 'N' },
                wiki: { en: "Hepatitis_B_vaccine", zh: "Bå‹è‚ç‚ç–«è‹—" }
            },
            { 
                id: 'flu', month: 6, type: 'Respiratory', 
                name: { en: "Influenza (Annual)", zh: "æµæ„Ÿç–«è‹— (æ¯å¹´)" }, 
                desc: { en: "Recommended annually from 6m.", zh: "æ»¿6å€‹æœˆå¾Œæ¯å¹´æ¥ç¨®ã€‚" }, 
                status: { TW: 'O', SG: 'O' },
                wiki: { en: "Influenza_vaccine", zh: "æµæ„Ÿç–«è‹—" }
            },
            // Month 12
            { 
                id: 'mmr-1', month: 12, type: 'MMRV', 
                name: { en: "MMR (Measles, Mumps, Rubella) (D1)", zh: "éº»ç–¹è…®è…ºç‚å¾·åœ‹éº»ç–¹ (ç¬¬1åŠ‘)" }, 
                desc: { en: "First dose.", zh: "ç¬¬ä¸€åŠ‘ã€‚" }, 
                status: { TW: 'M', SG: 'M' },
                wiki: { en: "MMR_vaccine", zh: "MMRç–«è‹—" }
            },
            { 
                id: 'var-1', month: 12, type: 'MMRV', 
                name: { en: "Varicella (Chickenpox) (D1)", zh: "æ°´ç—˜ç–«è‹— (ç¬¬1åŠ‘)" }, 
                desc: { en: "First dose.", zh: "ç¬¬ä¸€åŠ‘ã€‚" }, 
                status: { TW: 'M', SG: 'M' },
                wiki: { en: "Varicella_vaccine", zh: "æ°´ç—˜ç–«è‹—" }
            },
            { 
                id: 'pcv-3', month: 12, type: 'Respiratory', 
                name: { en: "Pneumococcal (Booster)", zh: "è‚ºç‚éˆçƒèŒ (è¿½åŠ åŠ‘)" }, 
                desc: { en: "Final toddler dose.", zh: "å¹¼å…’æœ€å¾Œä¸€åŠ‘ã€‚" }, 
                status: { TW: 'M', SG: 'M' },
                wiki: { en: "Pneumococcal_conjugate_vaccine", zh: "è‚ºç‚éˆçƒèŒç–«è‹—" }
            },
            { 
                id: 'hepa-1', month: 12, type: 'Hepatic', 
                name: { en: "Hepatitis A (Dose 1)", zh: "Aå‹è‚ç‚ (ç¬¬1åŠ‘)" }, 
                desc: { en: "Prevents food-borne liver virus.", zh: "é é˜²é£²é£Ÿå‚³æŸ“çš„Aè‚ç—…æ¯’ã€‚" }, 
                status: { TW: 'M', SG: 'O' },
                wiki: { en: "Hepatitis_A_vaccine", zh: "Aå‹è‚ç‚ç–«è‹—" }
            },
            // Month 15
            { 
                id: 'je-1', month: 15, type: 'Other', 
                name: { en: "Japanese Encephalitis (D1)", zh: "æ—¥æœ¬è…¦ç‚ (ç¬¬1åŠ‘)" }, 
                desc: { en: "Mosquito-borne. Live attenuated.", zh: "æ´»æ€§æ¸›æ¯’ç–«è‹—ã€‚" }, 
                status: { TW: 'M', SG: 'O' },
                wiki: { en: "Japanese_encephalitis_vaccine", zh: "æ—¥æœ¬è…¦ç‚ç–«è‹—" }
            },
            { 
                id: 'mmr-2-sg', month: 15, type: 'MMRV', 
                name: { en: "MMR (Dose 2)", zh: "éº»ç–¹è…®è…ºç‚å¾·åœ‹éº»ç–¹ (ç¬¬2åŠ‘)" }, 
                desc: { en: "SG Schedule (TW gives at 5yo).", zh: "æ–°åŠ å¡æ™‚ç¨‹ (å°ç£æ–¼å°å­¸å‰æ¥ç¨®)ã€‚" }, 
                status: { TW: 'N', SG: 'M' },
                wiki: { en: "MMR_vaccine", zh: "MMRç–«è‹—" }
            },
            { 
                id: 'var-2-sg', month: 15, type: 'MMRV', 
                name: { en: "Varicella (Dose 2)", zh: "æ°´ç—˜ç–«è‹— (ç¬¬2åŠ‘)" }, 
                desc: { en: "SG Schedule (TW 2nd dose optional).", zh: "æ–°åŠ å¡æ™‚ç¨‹ (å°ç£ç¬¬äºŒåŠ‘é¸ä¿®)ã€‚" }, 
                status: { TW: 'O', SG: 'M' },
                wiki: { en: "Varicella_vaccine", zh: "æ°´ç—˜ç–«è‹—" }
            },
            { 
                id: '5in1-booster-sg', month: 15, type: 'Combination', 
                name: { en: "5-in-1 Booster", zh: "äº”åˆä¸€ (è¿½åŠ åŠ‘)" }, 
                desc: { en: "SG Schedule booster.", zh: "æ–°åŠ å¡è¿½åŠ åŠ‘ã€‚" }, 
                status: { TW: 'N', SG: 'M' },
                wiki: { en: "Pentavalent_vaccine", zh: "äº”åˆä¸€ç–«è‹—" }
            },
            // Month 18
            { 
                id: '5in1-booster-tw', month: 18, type: 'Combination', 
                name: { en: "5-in-1 (D4)", zh: "äº”åˆä¸€ (ç¬¬4åŠ‘)" }, 
                desc: { en: "TW Schedule booster.", zh: "å°ç£æ™‚ç¨‹è¿½åŠ åŠ‘ã€‚" }, 
                status: { TW: 'M', SG: 'N' },
                wiki: { en: "Pentavalent_vaccine", zh: "äº”åˆä¸€ç–«è‹—" }
            },
            { 
                id: 'hepa-2', month: 18, type: 'Hepatic', 
                name: { en: "Hepatitis A (Dose 2)", zh: "Aå‹è‚ç‚ (ç¬¬2åŠ‘)" }, 
                desc: { en: "6 months after 1st dose.", zh: "èˆ‡ç¬¬ä¸€åŠ‘é–“éš”6å€‹æœˆã€‚" }, 
                status: { TW: 'M', SG: 'O' },
                wiki: { en: "Hepatitis_A_vaccine", zh: "Aå‹è‚ç‚ç–«è‹—" }
            }
        ];

        // --- Translations ---
        const translations = {
            en: {
                title: "Nayla's Vaccine Plan",
                born: "Born:",
                region: "Region",
                regionAll: "Compare (TW & SG)",
                regionTW: "Taiwan (TW)",
                regionSG: "Singapore (SG)",
                type: "Vaccine Type",
                typeAll: "All Types",
                showOptional: "Show Optional / Self-paid",
                age0: "At Birth",
                ageMonths: "Months",
                mandatory: "Mandatory",
                optional: "Optional",
                noData: "No vaccines match your filters.",
                toggleLang: "ä¸­æ–‡",
                growthTitle: "Growth Tracker (WHO Standards)",
                weight: "Weight (kg)",
                height: "Height (cm)",
                normal: "Normal Range",
                under: "Below Range",
                over: "Above Range",
                rangeInfoPart1: "Normal range is 3rd - 97th percentile for a",
                rangeInfoPart2: "month old girl",
                learnMore: "Learn More",
                wikiError: "Could not load Wikipedia summary.",
                readFull: "Read full article on Wikipedia",
                types: {
                    Respiratory: "Respiratory (Lungs)",
                    Hepatic: "Hepatic (Liver)",
                    Combination: "Combination (5-in-1 / 6-in-1)",
                    MMRV: "MMR & Chickenpox",
                    Gastrointestinal: "Gastrointestinal",
                    Other: "Other (Brain/Mosquito)"
                }
            },
            zh: {
                title: "å’–å’–ç–«è‹—æ¥ç¨®è¨ˆç•«",
                born: "å‡ºç”Ÿæ—¥æœŸï¼š",
                region: "åœ°å€",
                regionAll: "æ¯”è¼ƒ (å°ç£ & æ–°åŠ å¡)",
                regionTW: "å°ç£ (TW)",
                regionSG: "æ–°åŠ å¡ (SG)",
                type: "ç–«è‹—ç¨®é¡",
                typeAll: "æ‰€æœ‰ç¨®é¡",
                showOptional: "é¡¯ç¤ºè‡ªè²» / é¸ä¿®ç–«è‹—",
                age0: "å‡ºç”Ÿæ™‚",
                ageMonths: "å€‹æœˆ",
                mandatory: "å…¬è²» / å¼·åˆ¶",
                optional: "è‡ªè²» / é¸ä¿®",
                noData: "æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„ç–«è‹—ã€‚",
                toggleLang: "English",
                growthTitle: "ç”Ÿé•·æ›²ç·šè¿½è¹¤ (WHOæ¨™æº–)",
                weight: "é«”é‡ (kg)",
                height: "èº«é«˜ (cm)",
                normal: "æ­£å¸¸ç¯„åœ",
                under: "ä½æ–¼æ¨™æº–",
                over: "é«˜æ–¼æ¨™æº–",
                rangeInfoPart1: "æ­£å¸¸ç¯„åœç‚ºç¬¬3è‡³97ç™¾åˆ†ä½ï¼Œé©ç”¨æ–¼",
                rangeInfoPart2: "å€‹æœˆå¤§çš„å¥³å¯¶å¯¶",
                learnMore: "äº†è§£æ›´å¤š",
                wikiError: "ç„¡æ³•è¼‰å…¥ç¶­åŸºç™¾ç§‘æ‘˜è¦ã€‚",
                readFull: "é–±è®€ç¶­åŸºç™¾ç§‘å…¨æ–‡",
                types: {
                    Respiratory: "å‘¼å¸é“ (è‚ºéƒ¨)",
                    Hepatic: "è‚è‡Ÿé˜²è­· (Bè‚/Aè‚)",
                    Combination: "æ··åˆç–«è‹— (äº”/å…­åˆä¸€)",
                    MMRV: "éº»ç–¹ / è…®è…ºç‚ / æ°´ç—˜",
                    Gastrointestinal: "è…¸èƒƒé“ (è¼ªç‹€ç—…æ¯’)",
                    Other: "å…¶ä»– (æ—¥æœ¬è…¦ç‚ç­‰)"
                }
            }
        };

        // --- Logic ---
        function init() {
            // Language Detection
            const navLang = navigator.language || navigator.userLanguage;
            if (navLang && (navLang.toLowerCase().includes('zh') || navLang.toLowerCase().includes('cn'))) {
                state.lang = 'zh';
            }

            // Calculate Age
            const birth = new Date(BIRTH_DATE);
            const now = new Date();
            let months = (now.getFullYear() - birth.getFullYear()) * 12 + (now.getMonth() - birth.getMonth());
            if (now.getDate() < birth.getDate()) months--;
            state.currentAgeMonths = Math.max(0, months);

            // Populate Types
            const types = [...new Set(rawVaccines.map(v => v.type))].sort();
            const typeSelect = document.getElementById('filter-type');
            types.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                // Just use English key for value, we'll translate display text in render
                opt.text = t; 
                typeSelect.appendChild(opt);
            });

            renderApp();
            updateGrowth();
        }

        function toggleLang() {
            state.lang = state.lang === 'en' ? 'zh' : 'en';
            renderApp();
            updateGrowth();
        }

        function calculateDate(months) {
            const d = new Date(BIRTH_DATE);
            d.setMonth(d.getMonth() + months);
            return d.toLocaleDateString(state.lang === 'zh' ? 'zh-TW' : 'en-US', {
                year: 'numeric', month: 'short', day: 'numeric'
            });
        }

        // --- Wiki Functions ---
        async function openWiki(wikiKey) {
            const dialog = document.getElementById('wiki-dialog');
            const titleEl = document.getElementById('wiki-title');
            const contentEl = document.getElementById('wiki-content');
            const linkEl = document.getElementById('wiki-external-link');
            const t = translations[state.lang];

            // Reset UI
            titleEl.textContent = t.learnMore;
            contentEl.innerHTML = `<div class="flex justify-center py-8"><i class="fa-solid fa-circle-notch fa-spin text-indigo-500 text-2xl"></i></div>`;
            dialog.showModal();

            // Determine API URL
            // Wikipedia API: https://en.wikipedia.org/api/rest_v1/page/summary/{title}
            const langCode = state.lang === 'zh' ? 'zh' : 'en';
            const pageTitle = wikiKey; // Assuming wikiKey is the correct slug
            const apiUrl = `https://${langCode}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(pageTitle)}`;
            const wikiUrl = `https://${langCode}.wikipedia.org/wiki/${encodeURIComponent(pageTitle)}`;

            linkEl.href = wikiUrl;
            linkEl.innerHTML = `${t.readFull} <i class="fa-solid fa-arrow-up-right-from-square ml-1"></i>`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('Wiki fetch failed');
                const data = await response.json();

                // Build Content
                let html = '';
                if (data.thumbnail && data.thumbnail.source) {
                    html += `<img src="${data.thumbnail.source}" class="w-full h-48 object-cover rounded-lg mb-4 shadow-sm" alt="${data.title}">`;
                }
                html += `<h4 class="text-xl font-bold mb-2 text-slate-900">${data.title}</h4>`;
                html += `<p class="text-slate-600 leading-relaxed">${data.extract_html || data.extract}</p>`;
                
                contentEl.innerHTML = html;
                titleEl.textContent = data.title;

            } catch (error) {
                console.error(error);
                contentEl.innerHTML = `<p class="text-center text-red-500 py-4"><i class="fa-solid fa-triangle-exclamation mr-2"></i> ${t.wikiError}</p>`;
            }
        }

        function closeWiki() {
            document.getElementById('wiki-dialog').close();
        }

        // Close on click outside
        document.getElementById('wiki-dialog').addEventListener('click', (e) => {
            // Use e.currentTarget to ensure we get the dialog element, not a child
            const dialog = e.currentTarget;
            const dialogDimensions = dialog.getBoundingClientRect();
            if (
                e.clientX < dialogDimensions.left ||
                e.clientX > dialogDimensions.right ||
                e.clientY < dialogDimensions.top ||
                e.clientY > dialogDimensions.bottom
            ) {
                dialog.close();
            }
        });

        function getGrowthStandard() {
            const availableMonths = Object.keys(whoGirlsStandards).map(Number);
            const closest = availableMonths.reduce((prev, curr) => {
                return (Math.abs(curr - state.currentAgeMonths) < Math.abs(prev - state.currentAgeMonths) ? curr : prev);
            });
            return whoGirlsStandards[closest];
        }

        function updateGrowth() {
            const wVal = document.getElementById('input-weight').value;
            const hVal = document.getElementById('input-height').value;
            const standard = getGrowthStandard();
            const t = translations[state.lang];

            document.getElementById('growth-info').innerHTML = `${t.rangeInfoPart1} <strong>${state.currentAgeMonths} ${t.rangeInfoPart2}</strong>`;
            
            document.getElementById('weight-range').textContent = `${standard.w[0]} - ${standard.w[1]} kg`;
            document.getElementById('height-range').textContent = `${standard.h[0]} - ${standard.h[1]} cm`;

            const renderBadge = (val, range, id) => {
                const el = document.getElementById(id);
                if (!val) {
                    el.innerHTML = `<span class="text-slate-300 text-sm">-</span>`;
                    return;
                }
                const num = parseFloat(val);
                let text, colorClass;
                if (num < range[0]) {
                    text = t.under; colorClass = 'text-amber-600 bg-amber-50 border-amber-200';
                } else if (num > range[1]) {
                    text = t.over; colorClass = 'text-amber-600 bg-amber-50 border-amber-200';
                } else {
                    text = t.normal; colorClass = 'text-emerald-600 bg-emerald-50 border-emerald-200';
                }
                el.innerHTML = `<span class="inline-block px-2.5 py-1 rounded text-xs font-bold border ${colorClass}">${text}</span>`;
            };

            renderBadge(wVal, standard.w, 'weight-badge');
            renderBadge(hVal, standard.h, 'height-badge');
        }

        function renderApp() {
            const t = translations[state.lang];
            
            document.getElementById('nav-title').innerText = t.title;
            document.getElementById('nav-subtitle').innerText = `${t.born} ${BIRTH_DATE}`;
            document.getElementById('lang-btn-text').innerText = t.toggleLang;
            document.getElementById('growth-title').innerText = t.growthTitle;
            document.getElementById('label-weight').innerText = t.weight;
            document.getElementById('label-height').innerText = t.height;
            document.getElementById('res-label-weight').innerText = t.weight;
            document.getElementById('res-label-height').innerText = t.height;
            
            document.getElementById('label-region').innerText = t.region;
            document.getElementById('opt-all').innerText = t.regionAll;
            document.getElementById('opt-tw').innerText = t.regionTW;
            document.getElementById('opt-sg').innerText = t.regionSG;

            document.getElementById('label-type').innerText = t.type;
            document.getElementById('opt-type-all').innerText = t.typeAll;
            
            const typeSelect = document.getElementById('filter-type');
            Array.from(typeSelect.options).forEach(opt => {
                if (opt.value !== 'all' && t.types[opt.value]) {
                    opt.innerText = t.types[opt.value];
                }
            });

            document.getElementById('label-optional').innerText = t.showOptional;

            const filterCountry = document.getElementById('filter-country').value;
            const filterType = document.getElementById('filter-type').value;
            const showOptional = document.getElementById('filter-optional').checked;

            const filtered = rawVaccines.filter(v => {
                const statusTW = v.status.TW;
                const statusSG = v.status.SG;

                let isRelevant = false;
                if (filterCountry === 'all') isRelevant = (statusTW !== 'N') || (statusSG !== 'N');
                else if (filterCountry === 'TW') isRelevant = statusTW !== 'N';
                else if (filterCountry === 'SG') isRelevant = statusSG !== 'N';
                if (!isRelevant) return false;

                if (filterType !== 'all' && v.type !== filterType) return false;

                if (!showOptional) {
                    if (filterCountry === 'TW' && statusTW === 'O') return false;
                    if (filterCountry === 'SG' && statusSG === 'O') return false;
                    if (filterCountry === 'all' && statusTW !== 'M' && statusSG !== 'M') return false;
                }
                return true;
            }).sort((a, b) => a.month - b.month);

            const grouped = {};
            filtered.forEach(v => {
                if (!grouped[v.month]) grouped[v.month] = [];
                grouped[v.month].push(v);
            });

            const container = document.getElementById('timeline-container');
            container.innerHTML = '';

            const sortedMonths = Object.keys(grouped).sort((a,b) => Number(a)-Number(b));

            if (sortedMonths.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 mb-4 text-slate-400">
                             <i class="fa-solid fa-shield-virus text-2xl"></i>
                        </div>
                        <p class="text-slate-500 font-medium">${t.noData}</p>
                    </div>`;
                return;
            }

            sortedMonths.forEach(month => {
                const vaccines = grouped[month];
                const ageLabel = Number(month) === 0 ? t.age0 : `${month} ${t.ageMonths}`;
                const dateStr = calculateDate(Number(month));

                let html = `
                    <div class="relative pl-6 sm:pl-10">
                        <div class="timeline-line"></div>
                        <div class="timeline-dot shadow-sm"></div>
                        
                        <div class="flex flex-col sm:flex-row sm:items-baseline gap-2 mb-4">
                            <h2 class="text-xl font-bold text-slate-800">${ageLabel}</h2>
                            <span class="text-sm font-mono text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded w-fit">${dateStr}</span>
                        </div>

                        <div class="grid grid-cols-1 gap-4">
                `;

                vaccines.forEach(v => {
                    const name = state.lang === 'zh' ? v.name.zh : v.name.en;
                    const desc = state.lang === 'zh' ? v.desc.zh : v.desc.en;
                    const wikiKey = state.lang === 'zh' ? v.wiki.zh : v.wiki.en;
                    
                    const showTW = (filterCountry === 'all' || filterCountry === 'TW') && v.status.TW !== 'N';
                    const showSG = (filterCountry === 'all' || filterCountry === 'SG') && v.status.SG !== 'N';

                    const getBadgeHtml = (code) => {
                        if (code === 'M') return `<span class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded border border-blue-200 font-medium">${t.mandatory}</span>`;
                        if (code === 'O') return `<span class="bg-amber-100 text-amber-700 text-xs px-2 py-0.5 rounded border border-amber-200 font-medium">${t.optional}</span>`;
                        return '';
                    };

                    let badgesHtml = '';
                    if (showTW) {
                        badgesHtml += `<div class="flex items-center gap-1 bg-slate-50 border border-slate-200 rounded px-2 py-1"><span class="text-xs font-bold text-slate-600">TW ğŸ‡¹ğŸ‡¼</span>${getBadgeHtml(v.status.TW)}</div>`;
                    }
                    if (showSG) {
                        badgesHtml += `<div class="flex items-center gap-1 bg-slate-50 border border-slate-200 rounded px-2 py-1"><span class="text-xs font-bold text-slate-600">SG ğŸ‡¸ğŸ‡¬</span>${getBadgeHtml(v.status.SG)}</div>`;
                    }

                    html += `
                        <div class="vaccine-card bg-white rounded-xl p-5 shadow-sm border border-slate-200 group relative">
                            <div class="flex flex-col sm:flex-row justify-between gap-4">
                                <div class="flex-1 pr-8">
                                    <div class="flex flex-wrap gap-2 mb-2">
                                        ${badgesHtml}
                                    </div>
                                    <h3 class="font-bold text-lg text-slate-900">${name}</h3>
                                    <p class="text-sm text-slate-600 mt-1">${desc}</p>
                                    <button onclick="openWiki('${wikiKey}')" class="mt-3 inline-flex items-center text-xs font-medium text-indigo-500 hover:text-indigo-700 transition-colors">
                                        <i class="fa-brands fa-wikipedia-w mr-1"></i> ${t.learnMore}
                                    </button>
                                </div>
                                <div class="flex sm:flex-col items-center sm:items-end justify-between sm:justify-start gap-2">
                                    <span class="inline-flex items-center gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400 bg-slate-100 px-2 py-1 rounded">
                                        <i class="fa-solid fa-syringe text-[10px]"></i>
                                        ${v.type}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div></div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // Initialize
        init();

    </script>
</body>
</html>
