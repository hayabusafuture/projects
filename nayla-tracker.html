import React, { useState, useEffect, useMemo } from 'react';
import { Baby, Calendar, Globe, Syringe, Info, Check, ShieldAlert, Scale, Ruler, Activity } from 'lucide-react';

const VaccineSchedule = () => {
  // --- Configuration & State ---
  const BIRTH_DATE = '2025-11-11';
  
  const [lang, setLang] = useState('en');
  const [filters, setFilters] = useState({
    country: 'all', // 'all', 'TW', 'SG'
    type: 'all',
    showOptional: false,
  });
  
  const [measurements, setMeasurements] = useState({ weight: '', height: '' });

  // --- Localization ---
  useEffect(() => {
    const navLang = navigator.language || navigator.userLanguage;
    if (navLang && (navLang.toLowerCase().includes('zh') || navLang.toLowerCase().includes('cn'))) {
      setLang('zh');
    }
  }, []);

  const t = {
    en: {
      title: "Baby's Vaccine Plan",
      born: "Born:",
      region: "Region",
      regionAll: "Compare (TW & SG)",
      regionTW: "Taiwan (TW)",
      regionSG: "Singapore (SG)",
      type: "Vaccine Type",
      typeAll: "All Types",
      showOptional: "Show Optional / Self-paid",
      age0: "At Birth",
      ageMonths: "Months",
      mandatory: "Mandatory",
      optional: "Optional",
      noData: "No vaccines match your filters.",
      toggleLang: "ä¸­æ–‡",
      growthTitle: "Growth Tracker (WHO Standards)",
      weight: "Weight (kg)",
      height: "Height (cm)",
      check: "Check",
      normal: "Normal Range",
      under: "Below Range",
      over: "Above Range",
      rangeInfo: "Normal range is 3rd - 97th percentile for a",
      monthOldGirl: "month old girl",
      types: {
        Respiratory: "Respiratory (Lungs)",
        Hepatic: "Hepatic (Liver)",
        Combination: "Combination (5-in-1 / 6-in-1)",
        MMRV: "MMR & Chickenpox",
        Gastrointestinal: "Gastrointestinal",
        Other: "Other (Brain/Mosquito)"
      }
    },
    zh: {
      title: "å¯¶å¯¶ç–«è‹—æŽ¥ç¨®è¨ˆç•«",
      born: "å‡ºç”Ÿæ—¥æœŸï¼š",
      region: "åœ°å€",
      regionAll: "æ¯”è¼ƒ (å°ç£ & æ–°åŠ å¡)",
      regionTW: "å°ç£ (TW)",
      regionSG: "æ–°åŠ å¡ (SG)",
      type: "ç–«è‹—ç¨®é¡ž",
      typeAll: "æ‰€æœ‰ç¨®é¡ž",
      showOptional: "é¡¯ç¤ºè‡ªè²» / é¸ä¿®ç–«è‹—",
      age0: "å‡ºç”Ÿæ™‚",
      ageMonths: "å€‹æœˆ",
      mandatory: "å…¬è²» / å¼·åˆ¶",
      optional: "è‡ªè²» / é¸ä¿®",
      noData: "æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„ç–«è‹—ã€‚",
      toggleLang: "English",
      growthTitle: "ç”Ÿé•·æ›²ç·šè¿½è¹¤ (WHOæ¨™æº–)",
      weight: "é«”é‡ (kg)",
      height: "èº«é«˜ (cm)",
      check: "æª¢æŸ¥",
      normal: "æ­£å¸¸ç¯„åœ",
      under: "ä½Žæ–¼æ¨™æº–",
      over: "é«˜æ–¼æ¨™æº–",
      rangeInfo: "æ­£å¸¸ç¯„åœç‚ºç¬¬3è‡³97ç™¾åˆ†ä½ï¼Œé©ç”¨æ–¼",
      monthOldGirl: "å€‹æœˆå¤§çš„å¥³å¯¶å¯¶",
      types: {
        Respiratory: "å‘¼å¸é“ (è‚ºéƒ¨)",
        Hepatic: "è‚è‡Ÿé˜²è­· (Bè‚/Aè‚)",
        Combination: "æ··åˆç–«è‹— (äº”/å…­åˆä¸€)",
        MMRV: "éº»ç–¹ / è…®è…ºç‚Ž / æ°´ç—˜",
        Gastrointestinal: "è…¸èƒƒé“ (è¼ªç‹€ç—…æ¯’)",
        Other: "å…¶ä»– (æ—¥æœ¬è…¦ç‚Žç­‰)"
      }
    }
  }[lang];

  // --- Growth Logic ---
  const currentAgeMonths = useMemo(() => {
     const birth = new Date(BIRTH_DATE);
     const now = new Date(); 
     let months = (now.getFullYear() - birth.getFullYear()) * 12 + (now.getMonth() - birth.getMonth());
     if (now.getDate() < birth.getDate()) months--;
     return Math.max(0, months);
  }, []);

  // Simplified WHO Girls Data (0-24 months) - 3rd to 97th Percentile
  const whoGirlsStandards = {
    0: { w: [2.4, 4.2], h: [46.1, 53.7] },
    1: { w: [3.2, 5.4], h: [50.0, 57.4] },
    2: { w: [3.9, 6.6], h: [53.2, 60.9] },
    3: { w: [4.5, 7.5], h: [55.8, 63.8] },
    4: { w: [5.0, 8.2], h: [57.8, 66.4] },
    5: { w: [5.4, 8.8], h: [59.6, 68.5] },
    6: { w: [5.7, 9.3], h: [61.2, 70.3] },
    7: { w: [6.0, 9.8], h: [62.7, 71.9] },
    8: { w: [6.3, 10.2], h: [64.0, 73.5] },
    9: { w: [6.5, 10.5], h: [65.3, 75.0] },
    10: { w: [6.7, 10.9], h: [66.5, 76.4] },
    11: { w: [6.9, 11.2], h: [67.7, 77.8] },
    12: { w: [7.0, 11.5], h: [68.9, 79.2] },
    15: { w: [7.6, 12.4], h: [72.0, 83.0] },
    18: { w: [8.1, 13.2], h: [74.9, 86.5] },
    24: { w: [9.0, 14.8], h: [80.0, 92.9] },
  };

  // Get closest month data
  const growthStandard = useMemo(() => {
    const availableMonths = Object.keys(whoGirlsStandards).map(Number);
    const closest = availableMonths.reduce((prev, curr) => {
      return (Math.abs(curr - currentAgeMonths) < Math.abs(prev - currentAgeMonths) ? curr : prev);
    });
    return whoGirlsStandards[closest];
  }, [currentAgeMonths]);

  const getGrowthStatus = (val, range) => {
    if (!val) return null;
    const num = parseFloat(val);
    if (num < range[0]) return { status: 'under', color: 'text-amber-600 bg-amber-50 border-amber-200' };
    if (num > range[1]) return { status: 'over', color: 'text-amber-600 bg-amber-50 border-amber-200' };
    return { status: 'normal', color: 'text-emerald-600 bg-emerald-50 border-emerald-200' };
  };

  const weightStatus = getGrowthStatus(measurements.weight, growthStandard.w);
  const heightStatus = getGrowthStatus(measurements.height, growthStandard.h);

  // --- Data: Taiwan vs Singapore ---
  const rawVaccines = [
    {
      id: 'bcg',
      month: 0,
      type: 'Respiratory',
      name: { en: "BCG", zh: "å¡ä»‹è‹—" },
      desc: { en: "Tuberculosis protection.", zh: "é é˜²çµæ ¸ç—…ã€‚" },
      status: { TW: 'M', SG: 'M' }
    },
    {
      id: 'hepb-1',
      month: 0,
      type: 'Hepatic',
      name: { en: "Hepatitis B (Dose 1)", zh: "Båž‹è‚ç‚Ž (ç¬¬1åŠ‘)" },
      desc: { en: "Within 24hr of birth.", zh: "å‡ºç”Ÿ24å°æ™‚å…§æŽ¥ç¨®ã€‚" },
      status: { TW: 'M', SG: 'M' }
    },
    {
      id: 'hepb-2-tw',
      month: 1,
      type: 'Hepatic',
      name: { en: "Hepatitis B (Dose 2)", zh: "Båž‹è‚ç‚Ž (ç¬¬2åŠ‘)" },
      desc: { en: "Standard TW schedule.", zh: "å°ç£å¸¸è¦æ™‚ç¨‹ã€‚" },
      status: { TW: 'M', SG: 'N' } 
    },
    {
      id: '6in1-1',
      month: 2,
      type: 'Combination',
      name: { en: "6-in-1 (DTaP-IPV-Hib-HepB) (D1)", zh: "å…­åˆä¸€ç–«è‹— (ç¬¬1åŠ‘)" },
      desc: { en: "Diphtheria, Tetanus, Pertussis, Polio, Hib, HepB.", zh: "ç™½å–‰ã€ç ´å‚·é¢¨ã€ç™¾æ—¥å’³ã€å°å…’éº»ç—ºã€Båž‹å—œè¡€æ¡¿èŒã€Bè‚ã€‚" },
      status: { TW: 'N', SG: 'M' } 
    },
    {
      id: '5in1-1',
      month: 2,
      type: 'Combination',
      name: { en: "5-in-1 (DTaP-IPV-Hib) (D1)", zh: "äº”åˆä¸€ç–«è‹— (ç¬¬1åŠ‘)" },
      desc: { en: "Standard TW schedule (No HepB).", zh: "å°ç£å¸¸è¦ (ä¸å«Bè‚)ã€‚" },
      status: { TW: 'M', SG: 'N' }
    },
    {
      id: 'pcv-1',
      month: 2,
      type: 'Respiratory',
      name: { en: "Pneumococcal (PCV13/15) (D1)", zh: "13/15åƒ¹çµåˆåž‹è‚ºç‚ŽéˆçƒèŒ (ç¬¬1åŠ‘)" },
      desc: { en: "Pneumonia/Meningitis.", zh: "é é˜²è‚ºç‚ŽåŠè…¦è†œç‚Žã€‚" },
      status: { TW: 'M', SG: 'M' }
    },
    {
      id: 'rota-1',
      month: 2,
      type: 'Gastrointestinal',
      name: { en: "Rotavirus (Dose 1)", zh: "è¼ªç‹€ç—…æ¯’ (ç¬¬1åŠ‘)" },
      desc: { en: "Oral vaccine.", zh: "å£æœç–«è‹—ã€‚" },
      status: { TW: 'O', SG: 'O' }
    },
    {
      id: '6in1-2',
      month: 4,
      type: 'Combination',
      name: { en: "6-in-1 (D2)", zh: "å…­åˆä¸€ç–«è‹— (ç¬¬2åŠ‘)" },
      desc: { en: "SG Schedule.", zh: "æ–°åŠ å¡æ™‚ç¨‹ã€‚" },
      status: { TW: 'N', SG: 'M' }
    },
    {
      id: '5in1-2',
      month: 4,
      type: 'Combination',
      name: { en: "5-in-1 (D2)", zh: "äº”åˆä¸€ç–«è‹— (ç¬¬2åŠ‘)" },
      desc: { en: "TW Schedule.", zh: "å°ç£æ™‚ç¨‹ã€‚" },
      status: { TW: 'M', SG: 'N' }
    },
    {
      id: 'pcv-2',
      month: 4,
      type: 'Respiratory',
      name: { en: "Pneumococcal (PCV13/15) (D2)", zh: "è‚ºç‚ŽéˆçƒèŒ (ç¬¬2åŠ‘)" },
      desc: { en: "Second dose.", zh: "ç¬¬äºŒåŠ‘ã€‚" },
      status: { TW: 'M', SG: 'M' }
    },
    {
      id: '6in1-3',
      month: 6,
      type: 'Combination',
      name: { en: "6-in-1 (D3)", zh: "å…­åˆä¸€ç–«è‹— (ç¬¬3åŠ‘)" },
      desc: { en: "SG Schedule.", zh: "æ–°åŠ å¡æ™‚ç¨‹ã€‚" },
      status: { TW: 'N', SG: 'M' }
    },
    {
      id: '5in1-3',
      month: 6,
      type: 'Combination',
      name: { en: "5-in-1 (D3)", zh: "äº”åˆä¸€ç–«è‹— (ç¬¬3åŠ‘)" },
      desc: { en: "TW Schedule.", zh: "å°ç£æ™‚ç¨‹ã€‚" },
      status: { TW: 'M', SG: 'N' }
    },
    {
      id: 'hepb-3-tw',
      month: 6,
      type: 'Hepatic',
      name: { en: "Hepatitis B (Dose 3)", zh: "Båž‹è‚ç‚Ž (ç¬¬3åŠ‘)" },
      desc: { en: "TW Schedule final primary dose.", zh: "å°ç£æ™‚ç¨‹åŸºç¤ŽåŠ‘æœ€å¾Œä¸€åŠ‘ã€‚" },
      status: { TW: 'M', SG: 'N' } 
    },
    {
      id: 'flu',
      month: 6,
      type: 'Respiratory',
      name: { en: "Influenza (Annual)", zh: "æµæ„Ÿç–«è‹— (æ¯å¹´)" },
      desc: { en: "Recommended annually from 6m.", zh: "æ»¿6å€‹æœˆå¾Œæ¯å¹´æŽ¥ç¨®ã€‚" },
      status: { TW: 'O', SG: 'O' }
    },
    {
      id: 'mmr-1',
      month: 12,
      type: 'MMRV',
      name: { en: "MMR (Measles, Mumps, Rubella) (D1)", zh: "éº»ç–¹è…®è…ºç‚Žå¾·åœ‹éº»ç–¹ (ç¬¬1åŠ‘)" },
      desc: { en: "First dose.", zh: "ç¬¬ä¸€åŠ‘ã€‚" },
      status: { TW: 'M', SG: 'M' }
    },
    {
      id: 'var-1',
      month: 12,
      type: 'MMRV',
      name: { en: "Varicella (Chickenpox) (D1)", zh: "æ°´ç—˜ç–«è‹— (ç¬¬1åŠ‘)" },
      desc: { en: "First dose.", zh: "ç¬¬ä¸€åŠ‘ã€‚" },
      status: { TW: 'M', SG: 'M' }
    },
    {
      id: 'pcv-3',
      month: 12,
      type: 'Respiratory',
      name: { en: "Pneumococcal (Booster)", zh: "è‚ºç‚ŽéˆçƒèŒ (è¿½åŠ åŠ‘)" },
      desc: { en: "Final toddler dose.", zh: "å¹¼å…’æœ€å¾Œä¸€åŠ‘ã€‚" },
      status: { TW: 'M', SG: 'M' } 
    },
    {
      id: 'hepa-1',
      month: 12,
      type: 'Hepatic',
      name: { en: "Hepatitis A (Dose 1)", zh: "Aåž‹è‚ç‚Ž (ç¬¬1åŠ‘)" },
      desc: { en: "Prevents food-borne liver virus.", zh: "é é˜²é£²é£Ÿå‚³æŸ“çš„Aè‚ç—…æ¯’ã€‚" },
      status: { TW: 'M', SG: 'O' } 
    },
    {
      id: 'je-1',
      month: 15,
      type: 'Other',
      name: { en: "Japanese Encephalitis (D1)", zh: "æ—¥æœ¬è…¦ç‚Ž (ç¬¬1åŠ‘)" },
      desc: { en: "Mosquito-borne. Live attenuated.", zh: "æ´»æ€§æ¸›æ¯’ç–«è‹—ã€‚" },
      status: { TW: 'M', SG: 'O' } 
    },
    {
      id: 'mmr-2-sg',
      month: 15,
      type: 'MMRV',
      name: { en: "MMR (Dose 2)", zh: "éº»ç–¹è…®è…ºç‚Žå¾·åœ‹éº»ç–¹ (ç¬¬2åŠ‘)" },
      desc: { en: "SG Schedule (TW gives at 5yo).", zh: "æ–°åŠ å¡æ™‚ç¨‹ (å°ç£æ–¼å°å­¸å‰æŽ¥ç¨®)ã€‚" },
      status: { TW: 'N', SG: 'M' }
    },
    {
      id: 'var-2-sg',
      month: 15,
      type: 'MMRV',
      name: { en: "Varicella (Dose 2)", zh: "æ°´ç—˜ç–«è‹— (ç¬¬2åŠ‘)" },
      desc: { en: "SG Schedule (TW 2nd dose optional).", zh: "æ–°åŠ å¡æ™‚ç¨‹ (å°ç£ç¬¬äºŒåŠ‘é¸ä¿®)ã€‚" },
      status: { TW: 'O', SG: 'M' }
    },
    {
      id: '5in1-booster-sg',
      month: 15,
      type: 'Combination',
      name: { en: "5-in-1 Booster", zh: "äº”åˆä¸€ (è¿½åŠ åŠ‘)" },
      desc: { en: "SG Schedule booster.", zh: "æ–°åŠ å¡è¿½åŠ åŠ‘ã€‚" },
      status: { TW: 'N', SG: 'M' }
    },
    {
      id: '5in1-booster-tw',
      month: 18,
      type: 'Combination',
      name: { en: "5-in-1 (D4)", zh: "äº”åˆä¸€ (ç¬¬4åŠ‘)" },
      desc: { en: "TW Schedule booster.", zh: "å°ç£æ™‚ç¨‹è¿½åŠ åŠ‘ã€‚" },
      status: { TW: 'M', SG: 'N' }
    },
    {
      id: 'hepa-2',
      month: 18,
      type: 'Hepatic',
      name: { en: "Hepatitis A (Dose 2)", zh: "Aåž‹è‚ç‚Ž (ç¬¬2åŠ‘)" },
      desc: { en: "6 months after 1st dose.", zh: "èˆ‡ç¬¬ä¸€åŠ‘é–“éš”6å€‹æœˆã€‚" },
      status: { TW: 'M', SG: 'O' }
    }
  ];

  // --- Logic ---
  const calculateDate = (months) => {
    const d = new Date(BIRTH_DATE);
    d.setMonth(d.getMonth() + months);
    return d.toLocaleDateString(lang === 'zh' ? 'zh-TW' : 'en-US', {
      year: 'numeric', month: 'short', day: 'numeric'
    });
  };

  const processedVaccines = useMemo(() => {
    return rawVaccines.filter(v => {
      // 1. Filter by Country
      const statusTW = v.status.TW;
      const statusSG = v.status.SG;

      let isRelevant = false;
      if (filters.country === 'all') {
        isRelevant = (statusTW !== 'N') || (statusSG !== 'N');
      } else if (filters.country === 'TW') {
        isRelevant = statusTW !== 'N';
      } else if (filters.country === 'SG') {
        isRelevant = statusSG !== 'N';
      }

      if (!isRelevant) return false;

      // 2. Filter by Type
      if (filters.type !== 'all' && v.type !== filters.type) return false;

      // 3. Filter by Optional/Mandatory
      if (!filters.showOptional) {
        if (filters.country === 'TW' && statusTW === 'O') return false;
        if (filters.country === 'SG' && statusSG === 'O') return false;
        if (filters.country === 'all') {
          if (statusTW !== 'M' && statusSG !== 'M') return false;
        }
      }

      return true;
    }).sort((a, b) => a.month - b.month);
  }, [filters, lang]);

  const groupedVaccines = useMemo(() => {
    const groups = {};
    processedVaccines.forEach(v => {
      if (!groups[v.month]) groups[v.month] = [];
      groups[v.month].push(v);
    });
    return groups;
  }, [processedVaccines]);

  // --- Render Helpers ---
  const getBadge = (code) => {
    if (code === 'M') return <span className="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded border border-blue-200 font-medium">{t.mandatory}</span>;
    if (code === 'O') return <span className="bg-amber-100 text-amber-700 text-xs px-2 py-0.5 rounded border border-amber-200 font-medium">{t.optional}</span>;
    return null;
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-12">
      
      {/* Navbar */}
      <nav className="bg-white border-b border-slate-200 sticky top-0 z-10">
        <div className="max-w-3xl mx-auto px-4 py-4 flex justify-between items-center">
          <div className="flex items-center gap-3">
            <div className="bg-indigo-600 text-white p-2 rounded-lg shadow-sm">
              <Baby size={24} />
            </div>
            <div>
              <h1 className="text-xl font-bold tracking-tight text-slate-900 leading-tight">{t.title}</h1>
              <p className="text-xs text-slate-500 font-medium">{t.born} 2025-11-11</p>
            </div>
          </div>
          <button 
            onClick={() => setLang(l => l === 'en' ? 'zh' : 'en')}
            className="flex items-center gap-1.5 px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-medium rounded-full transition-colors"
          >
            <Globe size={16} />
            {t.toggleLang}
          </button>
        </div>
      </nav>

      <main className="max-w-3xl mx-auto px-4 py-6">

        {/* Growth Tracker */}
        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 mb-6">
          <div className="flex items-center gap-2 mb-4">
            <div className="bg-emerald-100 text-emerald-600 p-1.5 rounded-lg">
              <Activity size={18} />
            </div>
            <h2 className="font-bold text-slate-800">{t.growthTitle}</h2>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
             {/* Inputs */}
             <div className="grid grid-cols-2 gap-4">
                <div>
                   <label className="flex items-center gap-1.5 text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5">
                     <Scale size={14} /> {t.weight}
                   </label>
                   <input 
                      type="number" 
                      placeholder="e.g. 4.5"
                      className="w-full bg-slate-50 border border-slate-300 text-slate-900 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2.5"
                      value={measurements.weight}
                      onChange={(e) => setMeasurements({...measurements, weight: e.target.value})}
                   />
                </div>
                <div>
                   <label className="flex items-center gap-1.5 text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5">
                     <Ruler size={14} /> {t.height}
                   </label>
                   <input 
                      type="number" 
                      placeholder="e.g. 54"
                      className="w-full bg-slate-50 border border-slate-300 text-slate-900 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2.5"
                      value={measurements.height}
                      onChange={(e) => setMeasurements({...measurements, height: e.target.value})}
                   />
                </div>
             </div>

             {/* Results */}
             <div className="bg-slate-50 rounded-xl p-4 border border-slate-100 flex flex-col justify-center">
                <p className="text-xs text-slate-500 mb-3 text-center">
                   {t.rangeInfo} <strong>{currentAgeMonths} {t.monthOldGirl}</strong>
                </p>
                <div className="flex justify-around gap-2">
                   {/* Weight Result */}
                   <div className="text-center">
                      <span className="text-xs font-semibold text-slate-400 uppercase block mb-1">{t.weight}</span>
                      {weightStatus ? (
                        <span className={`inline-block px-2.5 py-1 rounded text-xs font-bold border ${weightStatus.color}`}>
                           {t[weightStatus.status]}
                        </span>
                      ) : (
                        <span className="text-slate-300 text-sm">-</span>
                      )}
                      <div className="text-[10px] text-slate-400 mt-1">
                         {growthStandard.w[0]} - {growthStandard.w[1]} kg
                      </div>
                   </div>
                   
                   <div className="w-px bg-slate-200"></div>

                   {/* Height Result */}
                   <div className="text-center">
                      <span className="text-xs font-semibold text-slate-400 uppercase block mb-1">{t.height}</span>
                      {heightStatus ? (
                        <span className={`inline-block px-2.5 py-1 rounded text-xs font-bold border ${heightStatus.color}`}>
                           {t[heightStatus.status]}
                        </span>
                      ) : (
                         <span className="text-slate-300 text-sm">-</span>
                      )}
                      <div className="text-[10px] text-slate-400 mt-1">
                         {growthStandard.h[0]} - {growthStandard.h[1]} cm
                      </div>
                   </div>
                </div>
             </div>
          </div>
        </div>

        {/* Filters */}
        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 mb-8">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            
            {/* Country Selector */}
            <div className="space-y-1.5">
              <label className="text-xs font-bold text-slate-400 uppercase tracking-wider">{t.region}</label>
              <div className="relative">
                <select 
                  className="w-full appearance-none bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5"
                  value={filters.country}
                  onChange={(e) => setFilters({...filters, country: e.target.value})}
                >
                  <option value="all">{t.regionAll}</option>
                  <option value="TW">{t.regionTW}</option>
                  <option value="SG">{t.regionSG}</option>
                </select>
                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
              </div>
            </div>

            {/* Type Selector */}
            <div className="space-y-1.5">
              <label className="text-xs font-bold text-slate-400 uppercase tracking-wider">{t.type}</label>
              <div className="relative">
                <select 
                  className="w-full appearance-none bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5"
                  value={filters.type}
                  onChange={(e) => setFilters({...filters, type: e.target.value})}
                >
                  <option value="all">{t.typeAll}</option>
                  {Object.keys(t.types).map(typeKey => (
                    <option key={typeKey} value={typeKey}>{t.types[typeKey]}</option>
                  ))}
                </select>
                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
              </div>
            </div>

            {/* Optional Toggle */}
            <div className="space-y-1.5 flex flex-col justify-end">
               <label className="flex items-center p-2.5 bg-slate-50 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                  <input 
                    type="checkbox" 
                    className="w-4 h-4 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500"
                    checked={filters.showOptional}
                    onChange={(e) => setFilters({...filters, showOptional: e.target.checked})}
                  />
                  <span className="ml-2 text-sm font-medium text-slate-700">{t.showOptional}</span>
               </label>
            </div>

          </div>
        </div>

        {/* Timeline */}
        <div className="space-y-8">
          {Object.keys(groupedVaccines).length === 0 && (
            <div className="text-center py-12">
              <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 mb-4">
                <ShieldAlert className="text-slate-400" size={32} />
              </div>
              <p className="text-slate-500 font-medium">{t.noData}</p>
            </div>
          )}

          {Object.keys(groupedVaccines).sort((a,b) => Number(a)-Number(b)).map(month => (
            <div key={month} className="relative pl-6 sm:pl-10 border-l-2 border-indigo-200">
              {/* Timeline Dot */}
              <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-indigo-500 border-4 border-slate-50 shadow-sm"></div>
              
              {/* Date Header */}
              <div className="flex flex-col sm:flex-row sm:items-baseline gap-2 mb-4">
                <h2 className="text-xl font-bold text-slate-800">
                  {Number(month) === 0 ? t.age0 : `${month} ${t.ageMonths}`}
                </h2>
                <span className="text-sm font-mono text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded w-fit">
                  {calculateDate(Number(month))}
                </span>
              </div>

              {/* Vaccine Cards */}
              <div className="grid grid-cols-1 gap-4">
                {groupedVaccines[month].map((v) => {
                  const showTW = (filters.country === 'all' || filters.country === 'TW') && v.status.TW !== 'N';
                  const showSG = (filters.country === 'all' || filters.country === 'SG') && v.status.SG !== 'N';

                  return (
                    <div key={v.id} className="group bg-white rounded-xl p-5 shadow-sm border border-slate-200 hover:shadow-md hover:border-indigo-200 transition-all">
                      <div className="flex flex-col sm:flex-row justify-between gap-4">
                        <div className="flex-1">
                          <div className="flex flex-wrap gap-2 mb-2">
                             {/* Country & Status Badges */}
                             {showTW && (
                               <div className="flex items-center gap-1 bg-slate-50 border border-slate-200 rounded px-2 py-1">
                                 <span className="text-xs font-bold text-slate-600">TW ðŸ‡¹ðŸ‡¼</span>
                                 {getBadge(v.status.TW)}
                               </div>
                             )}
                             {showSG && (
                               <div className="flex items-center gap-1 bg-slate-50 border border-slate-200 rounded px-2 py-1">
                                 <span className="text-xs font-bold text-slate-600">SG ðŸ‡¸ðŸ‡¬</span>
                                 {getBadge(v.status.SG)}
                               </div>
                             )}
                          </div>
                          
                          <h3 className="font-bold text-lg text-slate-900 group-hover:text-indigo-700 transition-colors">
                            {lang === 'zh' ? v.name.zh : v.name.en}
                          </h3>
                          <p className="text-sm text-slate-600 mt-1">
                            {lang === 'zh' ? v.desc.zh : v.desc.en}
                          </p>
                        </div>
                        
                        <div className="flex sm:flex-col items-center sm:items-end justify-between sm:justify-start gap-2">
                          <span className="inline-flex items-center gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400 bg-slate-100 px-2 py-1 rounded">
                            <Syringe size={12} />
                            {v.type}
                          </span>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          ))}
        </div>

      </main>
    </div>
  );
};

export default VaccineSchedule;
